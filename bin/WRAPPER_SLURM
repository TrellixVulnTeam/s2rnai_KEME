#!/bin/bash
#SBATCH --job-name="s2RNA_snake"
#SBATCH --partition="norm,niddk"
#SBATCH --cpus-per-task=1
#SBATCH --time=24:00:00
#SBATCH --mem=2g
set -e -o pipefail

CLUSTERCONFIG=../config/slurm_config.yaml
CONFIG=../config/config.yml

SNAKEFILE=$1
SNAKEFILENAME=`basename $1`
WORKDIR=`dirname $1`
echo "Setting working director: $WORKDIR"

SLURM_LOGS=$WORKDIR/slurm_logs
if [[ ! -e $SLURM_LOGS ]]; then mkdir -p $SLURM_LOGS; fi

if [[ ${2:+1} ]]; then
    EXTRA=$2
else
    EXTRA=targets
fi

(source activate s2rnai; \
    time snakemake \
    -p \
    -s $SNAKEFILE \
    --directory $WORKDIR \
    -T \
    -k \
    --rerun-incomplete \
    --jobname "s.{rulename}.{jobid}.sh" \
    -j 999 \
    --cluster-config $CLUSTERCONFIG \
    --configfile $CONFIG \
    --verbose \
    --cluster "sbatch --partition {cluster.partition} --cpus-per-task {threads} --mem {cluster.mem} --gres {cluster.gres} --time {cluster.time} --output=$SLURM_LOGS/${SNAKEFILENAME}.o.%j --error=$SLURM_LOGS/${SNAKEFILENAME}.e.%j" \
    --use-conda \
    --latency-wait=60 \
    $EXTRA \
    ) > "${SNAKEFILE}.log" 2>&1

SNAKE_PID=$!

finish(){
    echo 'Stopping running snakemake job.'
    kill -SIGINT $SNAKE_PID
    exit 0
}
trap finish SIGTERM

wait $SNAKE_PID
