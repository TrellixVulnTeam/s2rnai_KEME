#!/bin/bash
#SBATCH --job-name="seq_pipeline"
#SBATCH --partition="niddk,norm,b1"
#SBATCH --cpus-per-task=1
#SBATCH --time=48:00:00
#SBATCH --mem=700

source activate s2rnai

SNAKEFILE=$1
EXTRA=$2

if [ -n "$3" ]; then
    CONFIG=$3
else
    CONFIG=$HOME/devel/snakemakelib-oliver/data/slurm_cluster_config.yaml
fi

LOGS=../output/logs
if [[ ! -e $LOGS ]]; then mkdir -p $LOGS; fi

if [[ ! -e slurm_logs ]]; then mkdir -p slurm_logs; fi

(time snakemake \
    -p \
    --rerun-incomplete \
    --jobname "s.{rulename}.{jobid}.sh" \
    -j 100 \
    -k \
    --verbose \
    --cluster-config $CONFIG \
    --cluster "sbatch --partition {cluster.partition} --cpus-per-task {threads} --mem {cluster.mem} --gres {cluster.gres} --time {cluster.time} --output=slurm_logs/${SNAKEFILE}_${EXTRA}.%j --error=slurm_logs/${SNAKEFILE}_${EXTRA}.%j" \
    --latency-wait=60 \
    -s $SNAKEFILE \
    $EXTRA \
    ) > "$LOGS/${SNAKEFILE}_${EXTRA}.log" 2>&1

mail -s "$SNAKEFILE finished" $USER < "$LOGS/${SNAKEFILE}_${EXTRA}.log"
